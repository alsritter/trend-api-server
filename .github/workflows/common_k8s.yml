name: Aliyun K8s Deployment Workflow

on:
  workflow_call:
    inputs:
      dockerfile:
        required: true
        type: string
      image-name:
        required: true
        type: string
      container-name:
        required: true
        type: string
      namespace:
        required: false
        type: string
        default: "default"
      replicas:
        required: false
        type: string
        default: "2"
      container-port:
        required: false
        type: string
        default: "3000"
      service-port:
        required: false
        type: string
        default: "80"
      service-type:
        required: false
        type: string
        default: "ClusterIP"
      config-file-path:
        required: false
        type: string
        default: ""
      secret-file-path:
        required: false
        type: string
        default: ""
      env-from-configmap:
        required: false
        type: string
        default: ""
      env-from-secret:
        required: false
        type: string
        default: ""
      resource-limits-memory:
        required: false
        type: string
        default: "512Mi"
      resource-requests-memory:
        required: false
        type: string
        default: "256Mi"
    secrets:
      ALIYUN_USERNAME_K8S:
        required: true
      ALIYUN_PASSWORD_K8S:
        required: true
      KUBE_CONFIG_DATA:
        required: true
      WECHAT_WORK_BOT_WEBHOOK:
        required: true
      GH_PAT:
        required: true

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ inputs.container-name }}:${{ inputs.image-name }}-${{ github.run_number }}
      full-image: registry.cn-shenzhen.aliyuncs.com/qjwwy-pro/${{ inputs.container-name }}:${{ inputs.image-name }}-${{ github.run_number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GH_PAT }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to Aliyun Docker Registry
        uses: docker/login-action@v2
        with:
          registry: registry.cn-shenzhen.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME_K8S }}
          password: ${{ secrets.ALIYUN_PASSWORD_K8S }}

      - name: Print image details
        run: |
          echo "============================================"
          echo "ğŸ³ Docker é•œåƒæ„å»ºä¿¡æ¯"
          echo "============================================"
          echo "é•œåƒåç§°: ${{ inputs.container-name }}"
          echo "é•œåƒæ ‡ç­¾: ${{ inputs.image-name }}-${{ github.run_number }}"
          echo "å®Œæ•´é•œåƒåœ°å€: registry.cn-shenzhen.aliyuncs.com/qjwwy-pro/${{ inputs.container-name }}:${{ inputs.image-name }}-${{ github.run_number }}"
          echo "Dockerfile: ${{ inputs.dockerfile }}"
          echo "æ„å»ºä¸Šä¸‹æ–‡: ."
          echo "============================================"

      - name: Build and push Docker image
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ${{ inputs.dockerfile }}
          build-args: |
            name=app
          push: true
          tags: registry.cn-shenzhen.aliyuncs.com/qjwwy-pro/${{ inputs.container-name }}:${{ inputs.image-name }}-${{ github.run_number }}

      - name: Get current time (Shanghai)
        id: current-time
        run: |
          echo "time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Notify WeChat - Build Success
        uses: chf007/action-wechat-work@master
        env:
          WECHAT_WORK_BOT_WEBHOOK: ${{secrets.WECHAT_WORK_BOT_WEBHOOK}}
        with:
          msgtype: markdown
          content: |
            ### ğŸ‰ é•œåƒæ„å»ºæˆåŠŸ ğŸ‰
            **é¡¹ç›®**: ${{ github.repository }}
            **åˆ†æ”¯**: ${{ github.ref_name }}
            **ç‰ˆæœ¬**: ${{ inputs.image-name }}-${{ github.run_number }}
            **å®Œæ•´é•œåƒåœ°å€**: `registry.cn-shenzhen.aliyuncs.com/qjwwy-pro/${{ inputs.container-name }}:${{ inputs.image-name }}-${{ github.run_number }}`
            **è§¦å‘è€…**: ${{ github.actor }}
            **éƒ¨ç½²æ—¶é—´**: ${{ steps.current-time.outputs.time }} (CST)

  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GH_PAT || github.token }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v1

      - name: Set Kubernetes Context
        uses: azure/k8s-set-context@v1
        with:
          kubeconfig: ${{ secrets.KUBE_CONFIG_DATA }}

      - name: Get current time (Shanghai)
        id: current-time
        run: |
          echo "time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Apply ConfigMap from file
        if: inputs.config-file-path != ''
        run: |
          # ç¡®ä¿å‘½åç©ºé—´å­˜åœ¨
          kubectl get namespace ${{ inputs.namespace }} || kubectl create namespace ${{ inputs.namespace }}

          # åˆ›å»ºConfigMapåç§°
          CONFIG_MAP_NAME="${{ inputs.container-name }}-config"

          # åˆ›å»ºæˆ–æ›´æ–°ConfigMap
          kubectl create configmap ${CONFIG_MAP_NAME} --from-file=${{ inputs.config-file-path }} -n ${{ inputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "CONFIG_MAP_NAME=${CONFIG_MAP_NAME}" >> $GITHUB_ENV

      - name: Apply Secret from file
        if: inputs.secret-file-path != ''
        run: |
          # ç¡®ä¿å‘½åç©ºé—´å­˜åœ¨
          kubectl get namespace ${{ inputs.namespace }} || kubectl create namespace ${{ inputs.namespace }}

          # åˆ›å»ºSecretåç§°
          SECRET_NAME="${{ inputs.container-name }}-secret"

          # åˆ›å»ºæˆ–æ›´æ–°Secret
          kubectl create secret generic ${SECRET_NAME} --from-file=${{ inputs.secret-file-path }} -n ${{ inputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "SECRET_NAME=${SECRET_NAME}" >> $GITHUB_ENV

      - name: Create Deployment YAML
        run: |
          cat > deployment.yaml << 'EOL'
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ${{ inputs.container-name }}
            namespace: ${{ inputs.namespace }}
            labels:
              app: ${{ inputs.container-name }}
          spec:
            replicas: ${{ inputs.replicas }}
            selector:
              matchLabels:
                app: ${{ inputs.container-name }}
            template:
              metadata:
                labels:
                  app: ${{ inputs.container-name }}
              spec:
                # æ·»åŠ é•œåƒæ‹‰å–å‡­è¯
                imagePullSecrets:
                - name: ${{ inputs.image-pull-secret || 'aliyun-registry-secret' }}
                containers:
                - name: ${{ inputs.container-name }}
                  image: ${{ needs.build_and_push.outputs.full-image }}
                  ports:
                  - containerPort: ${{ inputs.container-port }}
                  resources:
                    limits:
                      memory: ${{ inputs.resource-limits-memory }}
                    requests:
                      memory: ${{ inputs.resource-requests-memory }}
          EOL

          # ä½¿ç”¨ConfigMapï¼ˆå¦‚æœåˆ›å»ºäº†ï¼‰
          if [ -n "${{ env.CONFIG_MAP_NAME }}" ]; then
            sed -i '/containers:/,/resources:/ s/\(.*\)resources:/\1envFrom:\n\1  - configMapRef:\n\1      name: ${{ env.CONFIG_MAP_NAME }}\n\1resources:/' deployment.yaml
          # å¦‚æœæ²¡æœ‰æ–°åˆ›å»ºçš„ConfigMapä½†æŒ‡å®šäº†env-from-configmap
          elif [ -n "${{ inputs.env-from-configmap }}" ]; then
            sed -i '/containers:/,/resources:/ s/\(.*\)resources:/\1envFrom:\n\1  - configMapRef:\n\1      name: ${{ inputs.env-from-configmap }}\n\1resources:/' deployment.yaml
          fi

          # ä½¿ç”¨Secretï¼ˆå¦‚æœåˆ›å»ºäº†ï¼‰
          if [ -n "${{ env.SECRET_NAME }}" ]; then
            if [ -n "${{ env.CONFIG_MAP_NAME }}" ] || [ -n "${{ inputs.env-from-configmap }}" ]; then
              # å¦‚æœå·²ç»æœ‰ConfigMapå¼•ç”¨ï¼Œæ·»åŠ Secretå¼•ç”¨
              sed -i '/configMapRef:/,/name:/ s/\(.*\)name:.*/\1name: '"${CONFIG_MAP_NAME:-${{ inputs.env-from-configmap }}}"'\n\1  - secretRef:\n\1      name: ${{ env.SECRET_NAME }}/' deployment.yaml
            else
              # å¦åˆ™ç›´æ¥æ·»åŠ Secretå¼•ç”¨
              sed -i '/containers:/,/resources:/ s/\(.*\)resources:/\1envFrom:\n\1  - secretRef:\n\1      name: ${{ env.SECRET_NAME }}\n\1resources:/' deployment.yaml
            fi
          # å¦‚æœæ²¡æœ‰æ–°åˆ›å»ºçš„Secretä½†æŒ‡å®šäº†env-from-secret
          elif [ -n "${{ inputs.env-from-secret }}" ]; then
            if [ -n "${{ env.CONFIG_MAP_NAME }}" ] || [ -n "${{ inputs.env-from-configmap }}" ]; then
              # å¦‚æœå·²æœ‰configMapï¼Œæ·»åŠ secretRef
              sed -i '/configMapRef:/,/name:/ s/\(.*\)name:.*/\1name: '"${CONFIG_MAP_NAME:-${{ inputs.env-from-configmap }}}"'\n\1  - secretRef:\n\1      name: ${{ inputs.env-from-secret }}/' deployment.yaml
            else
              # å¦‚æœæ²¡æœ‰configMapï¼Œç›´æ¥æ·»åŠ secretRef
              sed -i '/containers:/,/resources:/ s/\(.*\)resources:/\1envFrom:\n\1  - secretRef:\n\1      name: ${{ inputs.env-from-secret }}\n\1resources:/' deployment.yaml
            fi
          fi

      - name: Create Service YAML
        run: |
          cat > service.yaml << EOL
          apiVersion: v1
          kind: Service
          metadata:
            name: ${{ inputs.container-name }}-service
            namespace: ${{ inputs.namespace }}
          spec:
            selector:
              app: ${{ inputs.container-name }}
            ports:
            - port: ${{ inputs.service-port }}
              targetPort: ${{ inputs.container-port }}
            type: ${{ inputs.service-type }}
          EOL

      - name: Deploy to Kubernetes
        run: |
          # ç¡®ä¿å‘½åç©ºé—´å­˜åœ¨
          kubectl get namespace ${{ inputs.namespace }} || kubectl create namespace ${{ inputs.namespace }}

          # æ˜¾ç¤ºéƒ¨ç½²é…ç½®å†…å®¹ï¼ˆè°ƒè¯•ç”¨ï¼‰
          echo "Deploymenté…ç½®:"
          cat deployment.yaml
          echo "Serviceé…ç½®:"
          cat service.yaml

          # åº”ç”¨éƒ¨ç½²é…ç½®
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml

          # ç­‰å¾…éƒ¨ç½²å®Œæˆ
          kubectl rollout status deployment/${{ inputs.container-name }} -n ${{ inputs.namespace }} --timeout=300s

      - name: Get Service Details
        id: service-details
        run: |
          if [ "${{ inputs.service-type }}" == "LoadBalancer" ]; then
            EXTERNAL_IP=$(kubectl get svc ${{ inputs.container-name }}-service -n ${{ inputs.namespace }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
            echo "SERVICE_INFO=å¯é€šè¿‡è´Ÿè½½å‡è¡¡å™¨è®¿é—®: ${EXTERNAL_IP}:${{ inputs.service-port }}" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.service-type }}" == "NodePort" ]; then
            NODE_PORT=$(kubectl get svc ${{ inputs.container-name }}-service -n ${{ inputs.namespace }} -o jsonpath='{.spec.ports[0].nodePort}')
            echo "SERVICE_INFO=å¯é€šè¿‡èŠ‚ç‚¹ç«¯å£è®¿é—®: <èŠ‚ç‚¹IP>:${NODE_PORT}" >> $GITHUB_OUTPUT
          else
            echo "SERVICE_INFO=æœåŠ¡ç±»å‹ä¸º ClusterIPï¼Œä»…é›†ç¾¤å†…å¯è®¿é—®" >> $GITHUB_OUTPUT
          fi

      - name: Notify WeChat - Deploy Success
        uses: chf007/action-wechat-work@master
        env:
          WECHAT_WORK_BOT_WEBHOOK: ${{secrets.WECHAT_WORK_BOT_WEBHOOK}}
        with:
          msgtype: markdown
          content: |
            ### ğŸš€ éƒ¨ç½²æˆåŠŸ ğŸš€
            **é¡¹ç›®**: ${{ github.repository }}
            **åˆ†æ”¯**: ${{ github.ref_name }}
            **ç‰ˆæœ¬**: ${{ inputs.image-name }}-${{ github.run_number }}
            **å‘½åç©ºé—´**: ${{ inputs.namespace }}
            **å®¹å™¨å**: ${{ inputs.container-name }}
            **æœåŠ¡ä¿¡æ¯**: ${{ steps.service-details.outputs.SERVICE_INFO }}
            **æäº¤**: [${{ github.sha }}] ${{ github.event.head_commit.message }}
            **éƒ¨ç½²æ—¶é—´**: ${{ steps.current-time.outputs.time }} (CST)
            **éƒ¨ç½²äºº**: ${{ github.actor }}

  deploy_failure:
    needs: [build_and_push]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Get current time (Shanghai)
        id: current-time
        run: |
          echo "time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Notify WeChat - Deploy Failure
        uses: chf007/action-wechat-work@master
        env:
          WECHAT_WORK_BOT_WEBHOOK: ${{secrets.WECHAT_WORK_BOT_WEBHOOK}}
        with:
          msgtype: markdown
          content: |
            ### âŒ éƒ¨ç½²å¤±è´¥ âŒ
            **é¡¹ç›®**: ${{ github.repository }}
            **åˆ†æ”¯**: ${{ github.ref_name }}
            **ç‰ˆæœ¬**: ${{ inputs.image-name }}-${{ github.run_number }}
            **å¤±è´¥æ—¶é—´**: ${{ steps.current-time.outputs.time }} (CST)
            **è§¦å‘è€…**: ${{ github.actor }}

            è¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚
